<html><head>
    <title>KittyPaint!</title>
    
    <meta name="viewport" content="width=device-width" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    
	<link rel="shortcut icon" href="../favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/default.css"/>
    <link rel="stylesheet" type="text/css" href="css/login.css"/>
</head>
<body onclick="toggleZoomOff();toggleSizeOff();">

    <!-- login_popup -->
    <div id="white_login_screen">&nbsp;</div>
    <div id="login_cover">
        <table border="0px" width="100%" height="100%" style="z-index: 4;">
        <tr><td width="100%" height="100%"><center>
            <div class="login_box">
                <center>
                    <b>Welcome to KittyPaint!</b>
                    <br/><br/>
                    <input type="button" value="How to use KittyPaint" onclick="$('howtouse_cover').style.display='block';"/>
                    <br/><br/>
                </center>
                Connect to:
                <center>
                    <input type="button" value="KittyPaint servers" onclick="login_server('kittypaint.no-ip.org:27182');"/>
                    <br/>
                    <input type="button" value="Offline mode" onclick="login_offline_mode();"/>
                </center>
                <hr/>
                <i>advanced options</i>
                <center>
                    <input type="button" value="localhost" onclick="login_server('127.0.0.1:27182');"/>
                </center>
            </div>
        </center></td></tr>
        </table>
    </div>
    
    <!-- howtouse_popup -->
    <div id="howtouse_cover" style="display:none;">
        <table border="0px" width="100%" height="100%">
            <tr><td width="100%" height="100%"><center>
                <div class="login_box">
                    <center style="padding: 5px;"><b>How to use KittyPaint!</b></center>
                    <br/>
                    On mobile devices:
                    <ul>
                        <li><b>Touch and drag</b> to draw</li>
                        <li><b>Drag with 2 fingers</b> to move</li>
                    </ul>
                    On desktop:
                    <ul>

                        <li><b>Left click</b> to draw</li>
                        <li><b>Right click</b> and drag or <b>middle click</b> and drag to move</li>
                        <li>OR <b>hold m and move mouse</b> to move</li>
                        <li>OR use <b>arrow keys</b></li>
                    </ul>
                    Click the "+" button for advanced options.
                    <center>
                        <input type="button" value="ok" onclick="$('howtouse_cover').style.display='none';"/>
                    </center>
                </div>
            </center></td></tr>
        </table>
    </div>
    
    <!-- DRAWR -->
    <center id="drawr_drawr">	
		<div id="minimized_ui" class="drawr_ui" style="width:35px;height:35px;display:none;" onClick="toggleMinimizeUI();">
			<div class="selected_box" id="minimized_brush_box">&nbsp;</div>
		</div>
        <div id="drawr_ui" class="drawr_ui">
            <div class="button_holder">
                <div style="overflow: auto;">
                    <a href="#" style="margin-right:3px;" class="arrow_box" onClick="prevBrushPage(); return false;">&lt;&lt;</a>
                    <div class="select_box" id="brush_box0" onClick="selectBrush(0);">&nbsp;</div>
                    <div class="select_box" id="brush_box1" onClick="selectBrush(1);">&nbsp;</div>
                    <div class="select_box" id="brush_box2" onClick="selectBrush(2);">&nbsp;</div>
                    <div class="select_box" id="brush_box3" onClick="selectBrush(3);">&nbsp;</div>
                    <div class="select_box" id="brush_box4" onClick="selectBrush(4);">&nbsp;</div>
                    <div class="select_box" id="brush_box5" onClick="selectBrush(5);">&nbsp;</div>
                    <div class="select_box" id="brush_box6" onClick="selectBrush(6);">&nbsp;</div>
                    <div class="select_box" id="brush_box7" onClick="selectBrush(7);">&nbsp;</div>
                    <div class="select_box" id="brush_box8" onClick="selectBrush(8);">&nbsp;</div>
                    <div class="select_box" id="brush_box9" onClick="selectBrush(9);">&nbsp;</div>
                    <a href="#" class="arrow_box" id="right_brush_arrow" onClick="nextBrushPage(); return false;">&gt;&gt;</a>
                </div>
				
				<div style="overflow: auto;">
					<div id="size_picker">
						<div class="select_box" id="size_box0" onClick="selectBrushSize(0,1);">1</div>
						<div class="select_box" id="size_box1" onClick="selectBrushSize(1,4);">4</div>
						<div class="select_box" id="size_box2" onClick="selectBrushSize(2,8);">8</div>
						<div class="select_box" id="size_box3" onClick="selectBrushSize(3,16);">16</div>
						<div class="select_box" id="size_box4" onClick="selectBrushSize(4,32);">32</div>
					</div>
					<input type="color" class="select_box" id="color_box" onchange="editColor();">
					</input>
					<div class="select_box" id="stamp_box" onClick="toggleStampUI();" 
						style="background: url('brushes/createstamp.png')"></div>
						
					<div id="zoom_picker">
						<div id="zoom_box" class="select_box" onclick="toggleZoom();event.stopPropagation();"
							style="background: url('brushes/zoom.png'); line-height: 26px;">2</div>
						<div id="zoom_menu" class="drop_menu" style="position:absolute;top:0px;left:0px;display:none;">
							<div onclick="select_zoom(1);toggleZoom();">1</div>
							<div onclick="select_zoom(2);toggleZoom();">2</div>
							<div onclick="select_zoom(4);toggleZoom();">4</div>
							<div onclick="select_zoom(8);toggleZoom();">8</div>
							<div onclick="select_zoom(16);toggleZoom();">16</div>
						</div>
					</div>
					<div class="select_box" id="eyedrop_box" onClick="toggleEyeDrop();" 
						style="background: url('brushes/eyedrop.png')"></div>
            
					<div style="line-height:32px;float:left;text-align:center;margin-left:20px;">
						<div>
						&nbsp;
						<div style="display:inline;">
							<input type="button" value="&ndash;" id="toggle_min_tab" onClick="toggleMinimizeUI();"/>
							<input type="button" value="+" id="toggle_max_tab" onClick="toggleAdv();"/>
						</div>
						</div>
					</div>
                </div>
				<div style="overflow: auto; display:none;" id="stamp_options">
					<div class="select_box" style="visibility:hidden;"> :^) </div>
					<div class="select_box" style="visibility:hidden;"> :^) </div>
					<div class="select_box" style="visibility:hidden;"> :^) </div>
					<div class="select_box" style="visibility:hidden;"> :^) </div>
					<div class="select_box" style="visibility:hidden;"> :^) </div>
					
					<div class="select_box" id="mini_stamp_box" style="cursor:default;">
						<canvas id="ministampcanvas" oncontextmenu="return false;" width="32px" height="32px">
							Pls upgrade browser
						</canvas>
					</div>
					<div id="stamp_size_picker">
						<div id="size_box" class="select_box" onclick="toggleSize();event.stopPropagation();"
							style="background: url('brushes/size.png'); line-height: 26px;">16</div>
						<div id="size_menu" class="drop_menu" style="position:absolute;top:0px;left:0px;display:none;">
							<div onclick="select_size(16);toggleSize();">16</div>
							<div onclick="select_size(32);toggleSize();">32</div>
						</div>
					</div>
					<div class="select_box">save</div>
					<div class="select_box" onclick="stampdrawr.clearCanvas();">clear</div>
					<div id="stamp_erase_box" class="select_box" onclick="toggleStampErase();">erase</div>
					<div class="select_box">:^)</div>
				</div>
            </div>
			
            <span id="adv_tab" style="display:none;">
				<div class="button_holder">
					auto-hide ui: <input id="auto_hide_ui" type="checkbox" onClick="toggleAutoHideUI();">
				</div>
                <div class="button_holder">
                    server: <input type="text" id="server_url" class="server_box" value="127.0.0.1:27182"/>
                    <input type="button" value="connect" onClick="set_server();"/>
                </div>
				<br/>
				<div class="button_holder">
                    <input type="text" id="tele_waypoint" class="position_box" placeholder="Enter waypoint..."/>
                    <input type="button" value="go" onclick="teleport_go();"/>
				</div>
				<div class="button_holder">
                    <input type="button" value="debug: off" id="debug_toggle" onclick="debug_toggle();"/>
                </div>
                <div class="button_holder" style="overflow-y:scroll;height:3em;border: 1px solid black;">
                    <div id="debug">-<br/>-<br/>-</div>
                </div>
            </span>
        </div>

        <canvas id="kittycanvas" oncontextmenu="return false;">
            Pls upgrade browser
        </canvas>
		
        <canvas id="stampcanvas" oncontextmenu="return false;">
			Pls upgrade browser
		</canvas>
    </center>
</body>

<!-- UI SCRIPTS -->
<script type="text/javascript" src="login_popup.js"></script>
<script type="text/javascript" src="ui_toggles.js"></script>
<script type="text/javascript" src="ui_fixer_selectors.js"></script>

<!-- DRAWR SCRIPTS -->
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="md5_crypt.js"></script>
<script type="text/javascript" src="drawr_brushes.js"></script>
<script type="text/javascript" src="drawr_map.js"></script>
<script type="text/javascript" src="drawr_client.js"></script>
<script type="text/javascript" src="drawr.js"></script>
<script type="text/javascript" src="drawr_input.js"></script>
<script type="text/javascript" src="stampscripts/stampdrawr_map.js"></script>
<script type="text/javascript" src="stampscripts/stampdrawr.js"></script>
<script type="text/javascript" src="stampscripts/stampdrawr_input.js"></script>

<!-- !! -->
<script type="text/javascript" src="dumb/ascii.js"></script>

<script type="text/javascript">
    
    var DEBUG_MODE_GLOBAL = 0;
    function debug_toggle(){
        if(!DEBUG_MODE_GLOBAL){
            DEBUG_MODE_GLOBAL = 1;
            $("debug_toggle").value = "debug: on";
        }else{
            DEBUG_MODE_GLOBAL = 0;
            $("debug_toggle").value = "debug: off";
        }
    }
    
    var num_brush_boxes = 10;
    var num_available_brush_boxes = 10;
	var brush_box_page = 0;
	var num_brush_box_pages = 0;
	var brush_boxes = [];
	var num_size_boxes = 5;
	var size_boxes = [];
	var current_brushes = [];
	var brush_index = 0;
	var brush_size_index = 2;
	var brush_size = 8;
	var auto_hide_ui = false;
	
	function toggleAutoHideUI(){
		auto_hide_ui = !auto_hide_ui;
	}
    
    for (var i=0; i<num_brush_boxes;++i){
        brush_boxes[i] = $("brush_box"+i);
    }
    for (var i=0; i<num_size_boxes;++i){
        size_boxes[i] = $("size_box"+i);
    }
	//TODO:: Update this selectedIndex if we update the zoom select options
    /*$("zoom_list").selectedIndex = 1;*/
    
    
	/******* SETUP *******/
	var brushes;
	var drawr_client;
	var drawr;
	var stampdrawr;
	
	window.onload = function(){
		brushes = new DrawrBrushes(function(){  // maybe we need a loading screen for this
			//Load Brushes
			num_brush_box_pages = Math.ceil(brushes.getBrushes().length/num_available_brush_boxes);
			setBrushBoxes();
		});
    
		drawr_client = new DrawrClient("127.0.0.1:27182");
    
		drawr = new KittyDrawr("kittycanvas", brushes, drawr_client, "debug");
		drawr.addEventListener("mapmove", update_position_box);
	
		stampdrawr = new StampDrawr("stampcanvas", "ministampcanvas", brushes, "debug");
		
		ui_onresize();
	}
    
    var default_onresize = window.onresize || function(){};
    window.onresize = function(){ ui_onresize(); default_onresize(); }
    function ui_onresize(){
        // see if the line of brush boxes wraps around. if so, hide the ones that go too far past the edge, so it stays 1 row.
        var brush_box_row1 = $("brush_box0").offsetTop;
        var s = brush_box_row1 + " ";
        var count_row1_boxes = 1;
        for (var i=1; i<num_brush_boxes;++i){
			var thisbox_top = $("brush_box"+i).offsetTop;
            s += thisbox_top + " ";
            if(thisbox_top == 0 || $("brush_box"+i).style.display == "none"){
                // block is hidden, make it visible to check where its offset would be
                $("brush_box"+i).style.display = "block";
                thisbox_top = $("brush_box"+i).offsetTop;
            }
            if(thisbox_top == brush_box_row1){
                count_row1_boxes++;
                $("brush_box"+i).style.display = "block";
            }else{
                $("brush_box"+i).style.display = "none";
            }
		}
        //hide 1 more brush_box if the arrow button is moved to next line too!
        if($("right_brush_arrow").offsetTop != brush_box_row1){
            if(count_row1_boxes > 2){ // make sure we actually have a button to hide
                count_row1_boxes -= 1;
                $("brush_box"+count_row1_boxes).style.display = "none";
            }
        }
        
        num_available_brush_boxes = count_row1_boxes;
		num_brush_box_pages = Math.ceil(brushes.getBrushes().length/num_available_brush_boxes);
		setBrushBoxes();
		stampdrawr.resize();
    }

    function showAndroidToast(toast) {
        Android.showToast(toast);
    }
	
	/***NOT SETUP***/	
	function prevBrushPage(){
		brush_box_page--;
		if (brush_box_page < 0) brush_box_page = num_brush_box_pages-1;
		setBrushBoxes();
	}
	
	function nextBrushPage(){
		brush_box_page++;
		if (brush_box_page >= num_brush_box_pages) brush_box_page = 0;
		setBrushBoxes();
	}
    
    function teleport_go(){
        var waypointstr = $("tele_waypoint").value;
        if(waypointstr != ""){
            var rstr_loc = hex_md5(waypointstr);
            var hex_x = rstr_loc.substr(0,8);
            var hex_y = rstr_loc.substr(8,8);
            var x = parseInt(hex_x, 16) - 0xffffffff/2;
            var y = parseInt(hex_y, 16) - 0xffffffff/2;
            console.log(x + "," + y);
        }else{
            var x = 0;
            var y = 0;
        }
        
        drawr.drawr_map.setIngameOffsetX(x);
        drawr.drawr_map.setIngameOffsetY(y);
        drawr.loadNearbyChunks();
    }

    function update_position_box(){
        //$("tele_waypoint").value = "";
    }
    
    function set_server(){
        var server = $("server_url").value;
        if(!server.match(/^[^\/]*$/)){
            server = drawr_client.server;
            $("server_url").value = server;
        }
        drawr_client.stop();
        drawr_client.server = server;
        drawr_client.start();
        
        drawr.drawr_map.setOfflineMode(0);
        drawr.refresh();
    }
    
    function get_room(){
        return $("room").value.replace(/\&/, "");
    }
    
    
    
    
    
    
    function add_one(){
        /*url_post = get_server() + "/post?" + get_room() + "&" + makeobjo();
        loadJSON(url_post, function(jsonObj){
            newest_id = 1 * jsonObj;
            debug.innerHTML += "id: " + newest_id + ",";
        });*/
        drawrObjects.push(makeobjo());
    }
    
    var do_updatingu = 1;
    function toggle_update(){
        do_updatingu = !do_updatingu;
        $("toggle_update").value = "update: " + (do_updatingu ? "on" : "off");
    }
    
    function update(){
        if(!do_updatingu) return;
        loadJSON(get_server() + "/get?" + get_room() + "&-1", function(jsonObj){
            debug.innerHTML = JSON.stringify(jsonObj);
            
            // since requesting from -1
            drawrObjects = [];
            for(var i=0; i<jsonObj.length; ++i){
                drawrObjects.push(DrawrPath.fromJSON(jsonObj[i]));
            }
        });
    }
    
    function clear_drawr(){
        url_post = get_server() + "/clear?" + get_room();
        loadJSON(url_post, function(jsonObj){
            if(jsonObj*1 == 0){
                drawrObjects = [];
                debug.innerHTML = "";
            }
        });
    }
    
    //////////////////////////////////////////setInterval(update, 500);
</script>
</html>